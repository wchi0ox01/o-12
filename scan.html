<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สแกนใบหน้าเช็คชื่อ - ระบบเช็คชื่อวิทยาลัย</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Kanit', sans-serif; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto p-4 md:p-6 max-w-4xl">
        <!-- Header -->
        <header class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i data-lucide="scan-face" class="text-white w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-gray-800">ระบบเช็คชื่อวิทยาลัย</h1>
                        <p class="text-gray-600 text-sm">สแกนใบหน้าเพื่อเช็คชื่อ</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden sm:block text-right">
                        <p class="font-medium text-gray-800" id="student-name-display"></p>
                        <p class="text-sm text-gray-600" id="student-id-display"></p>
                    </div>
                    <div class="w-12 h-12 bg-gray-200 rounded-full overflow-hidden border-2 border-white shadow">
                        <img id="student-avatar" src="" class="w-full h-full object-cover">
                    </div>
                </div>
            </div>
        </header>

        <!-- Student Info Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="flex items-center space-x-4">
                    <img id="student-photo" src="" class="w-20 h-20 rounded-2xl object-cover border-4 border-blue-100 shadow">
                    <div>
                        <p class="text-lg font-bold text-gray-800" id="student-name"></p>
                        <p class="text-gray-600" id="student-id"></p>
                        <p class="text-gray-600" id="student-class"></p>
                    </div>
                </div>
                <div class="flex items-center justify-center">
                    <div class="text-center">
                        <p class="text-sm text-gray-500">สถานะการเช็คชื่อวันนี้</p>
                        <p id="attendance-status" class="text-xl font-bold text-gray-800 mt-2">ยังไม่ได้เช็คชื่อ</p>
                        <p id="attendance-time" class="text-sm text-gray-500 mt-1">-</p>
                    </div>
                </div>
                <div class="flex items-center justify-center">
                    <div class="text-center">
                        <p class="text-sm text-gray-500">ตำแหน่งปัจจุบัน</p>
                        <p id="location-status" class="text-sm font-medium text-gray-800 mt-2">กำลังตรวจสอบ...</p>
                        <p id="location-distance" class="text-xs text-gray-500 mt-1">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scanning Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div id="start-scan-section">
                <div class="text-center py-8">
                    <div class="w-20 h-20 bg-gradient-to-r from-green-500 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="camera" class="text-white w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">พร้อมเช็คชื่อ</h2>
                    <p class="text-gray-600 mb-6">กดปุ่มด้านล่างเพื่อเริ่มสแกนใบหน้าและยืนยันตำแหน่งที่ตั้ง</p>
                    <button onclick="startScanning()" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-4 rounded-2xl hover:from-green-600 hover:to-green-700 transition-all duration-200 text-lg font-semibold flex items-center justify-center mx-auto gap-3 shadow-lg">
                        <i data-lucide="camera"></i>
                        <span>เริ่มสแกนใบหน้า</span>
                    </button>
                </div>
            </div>
            
            <div id="scanning-section" class="hidden">
                <div class="flex flex-col items-center">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">กำลังสแกนใบหน้า...</h2>
                    <div id="video-loader" class="flex flex-col items-center justify-center h-64 w-full">
                        <div class="loader w-12 h-12 rounded-full border-4 border-blue-200"></div>
                        <p id="video-loading-text" class="mt-4 text-gray-600">กำลังเปิดกล้องและตรวจสอบตำแหน่ง...</p>
                    </div>
                    <div class="w-full max-w-2xl mx-auto bg-black rounded-2xl overflow-hidden relative aspect-video hidden shadow-2xl" id="video-wrapper">
                        <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                        <canvas id="overlay" class="absolute top-0 left-0 w-full h-full"></canvas>
                        <div id="scan-success-overlay" class="absolute inset-0 bg-gradient-to-br from-green-500/90 to-green-600/90 text-white flex flex-col items-center justify-center hidden animate-fade-in p-6">
                            <i data-lucide="check-circle" class="w-16 h-16 mb-4"></i>
                            <h3 class="text-2xl font-bold mb-2">เช็คชื่อสำเร็จ!</h3>
                            <p class="text-xl" id="scan-success-name"></p>
                            <p class="text-lg opacity-90 mt-2" id="scan-success-time"></p>
                        </div>
                        <div id="scan-error-overlay" class="absolute inset-0 bg-gradient-to-br from-red-500/90 to-red-600/90 text-white flex flex-col items-center justify-center hidden animate-fade-in p-6">
                            <i data-lucide="x-circle" class="w-16 h-16 mb-4"></i>
                            <h3 class="text-2xl font-bold mb-2" id="error-title"></h3>
                            <p class="text-lg text-center opacity-90" id="error-message"></p>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button onclick="stopScanning()" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-8 py-3 rounded-2xl hover:from-red-600 hover:to-red-700 transition-all duration-200 font-semibold flex items-center justify-center mx-auto gap-2">
                        <i data-lucide="stop-circle"></i>
                        <span>ยกเลิกการสแกน</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6">
                <div class="flex items-start gap-3">
                    <i data-lucide="clock" class="w-6 h-6 text-blue-600 mt-1"></i>
                    <div>
                        <h3 class="font-semibold text-blue-800 mb-2">เวลาที่กำหนด</h3>
                        <p class="text-blue-700 text-sm">จันทร์ - ศุกร์<br>เวลา 06:00 - 08:30 น.</p>
                    </div>
                </div>
            </div>
            <div class="bg-green-50 border border-green-200 rounded-2xl p-6">
                <div class="flex items-start gap-3">
                    <i data-lucide="map-pin" class="w-6 h-6 text-green-600 mt-1"></i>
                    <div>
                        <h3 class="font-semibold text-green-800 mb-2">พื้นที่ที่กำหนด</h3>
                        <p class="text-green-700 text-sm">ภายในรัศมี 50 เมตร<br>จากหน้าเสาธงวิทยาลัย</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isScanning = false;
        let videoStream = null;
        let recognitionInterval = null;
        let studentData = null;
        let faceMatcher = null;
        let currentLocation = null;

        // ฟังก์ชันโหลดข้อมูลนักเรียน
        function loadStudentData() {
            const data = localStorage.getItem('studentData');
            if (data) {
                studentData = JSON.parse(data);
                
                // แสดงข้อมูลนักเรียน
                document.getElementById('student-photo').src = studentData.imageData;
                document.getElementById('student-avatar').src = studentData.imageData;
                document.getElementById('student-name').textContent = studentData.name;
                document.getElementById('student-name-display').textContent = studentData.name;
                document.getElementById('student-id').textContent = `รหัส: ${studentData.id}`;
                document.getElementById('student-id-display').textContent = studentData.id;
                document.getElementById('student-class').textContent = `ห้อง: ${studentData.class}`;
                
                // ตรวจสอบสถานะการเช็คชื่อวันนี้
                checkTodayAttendance();
                
                // เริ่มตรวจสอบตำแหน่ง
                startLocationTracking();
            } else {
                // ถ้าไม่มีข้อมูลนักเรียน ให้กลับไปหน้าแรก
                window.location.href = 'index.html';
            }
        }

        // ฟังก์ชันตรวจสอบการเช็คชื่อวันนี้
        function checkTodayAttendance() {
            const today = new Date().toDateString();
            const attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '{}');
            
            if (attendanceData[today] && attendanceData[today][studentData.id]) {
                const record = attendanceData[today][studentData.id];
                document.getElementById('attendance-status').textContent = 'เช็คชื่อแล้ว';
                document.getElementById('attendance-status').classList.add('text-green-600');
                document.getElementById('attendance-time').textContent = `เวลา: ${record.time}`;
            }
        }

        // ฟังก์ชันติดตามตำแหน่ง
        function startLocationTracking() {
            updateLocation();
            // อัพเดทตำแหน่งทุก 10 วินาที
            setInterval(updateLocation, 10000);
        }

        function updateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        checkLocationValidity(currentLocation);
                    },
                    (error) => {
                        document.getElementById('location-status').textContent = 'ไม่สามารถระบุตำแหน่งได้';
                        document.getElementById('location-status').className = 'text-sm font-medium text-red-600';
                        document.getElementById('location-distance').textContent = 'กรุณาอนุญาตการเข้าถึงตำแหน่ง';
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }

        // ฟังก์ชันตรวจสอบตำแหน่ง
        function checkLocationValidity(location) {
            const collegeCenter = { lat: 14.529033, lng: 100.907445 };
            const radius = 50; // เมตร
            
            // คำนวณระยะทาง
            const R = 6371000;
            const dLat = (location.lat - collegeCenter.lat) * Math.PI / 180;
            const dLng = (location.lng - collegeCenter.lng) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(collegeCenter.lat * Math.PI / 180) * Math.cos(location.lat * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            document.getElementById('location-distance').textContent = `ระยะทาง: ${Math.round(distance)} เมตร`;
            
            if (distance <= radius) {
                document.getElementById('location-status').textContent = 'อยู่ในพื้นที่วิทยาลัย';
                document.getElementById('location-status').className = 'text-sm font-medium text-green-600';
                return true;
            } else {
                document.getElementById('location-status').textContent = 'อยู่นอกพื้นที่วิทยาลัย';
                document.getElementById('location-status').className = 'text-sm font-medium text-red-600';
                return false;
            }
        }

        // ฟังก์ชันตรวจสอบเวลา
        function isWithinCheckInTime() {
            const now = new Date();
            const day = now.getDay();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            // ตรวจสอบวันจันทร์-ศุกร์ (1-5)
            if (day < 1 || day > 5) {
                return { valid: false, message: 'ไม่อยู่ในวันทำงาน (จันทร์-ศุกร์)' };
            }
            
            // ตรวจสอบเวลา 6:00-8:30
            const currentTime = hours * 60 + minutes;
            const startTime = 6 * 60;   // 6:00
            const endTime = 8 * 60 + 30; // 8:30
            
            if (currentTime < startTime) {
                return { valid: false, message: 'ยังไม่ถึงเวลาเช็คชื่อ (เริ่ม 6:00 น.)' };
            } else if (currentTime > endTime) {
                return { valid: false, message: 'เลยเวลาเช็คชื่อแล้ว (สิ้นสุด 8:30 น.)' };
            } else {
                return { valid: true };
            }
        }

        // ฟังก์ชันเริ่มการสแกน
        async function startScanning() {
            // ตรวจสอบตำแหน่ง
            if (!currentLocation) {
                showError('ไม่สามารถระบุตำแหน่งได้', 'กรุณาอนุญาตการเข้าถึงตำแหน่งที่ตั้ง');
                return;
            }

            if (!checkLocationValidity(currentLocation)) {
                showError('อยู่นอกพื้นที่', 'กรุณาเข้ามาภายในรัศมี 50 เมตรจากหน้าเสาธง');
                return;
            }

            // ตรวจสอบเวลา
            const timeCheck = isWithinCheckInTime();
            if (!timeCheck.valid) {
                showError('ไม่อยู่ในเวลาที่กำหนด', timeCheck.message);
                return;
            }

            document.getElementById('start-scan-section').classList.add('hidden');
            document.getElementById('scanning-section').classList.remove('hidden');
            isScanning = true;
            startVideo();
        }

        // ฟังก์ชันหยุดการสแกน
        function stopScanning() {
            isScanning = false;
            if (recognitionInterval) {
                clearInterval(recognitionInterval);
                recognitionInterval = null;
            }

            const video = document.getElementById('video');
            video.removeEventListener('play', onVideoPlay);
            if (video.srcObject) { 
                video.srcObject.getTracks().forEach(track => track.stop()); 
                video.srcObject = null;
            }

            document.getElementById('video-loader').style.display = 'flex';
            document.getElementById('video-loading-text').innerText = 'กำลังเปิดกล้อง...';
            document.getElementById('video-wrapper').classList.add('hidden');
            document.getElementById('scan-success-overlay').classList.add('hidden');
            document.getElementById('scan-error-overlay').classList.add('hidden');
            document.getElementById('scanning-section').classList.add('hidden');
            document.getElementById('start-scan-section').classList.remove('hidden');
        }

        // ฟังก์ชันแสดงข้อผิดพลาด
        function showError(title, message) {
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
            document.getElementById('scan-error-overlay').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('scan-error-overlay').classList.add('hidden');
            }, 3000);
        }

        // ฟังก์ชันเริ่มวิดีโอ
        async function startVideo() {
            const video = document.getElementById('video');
            video.addEventListener('play', onVideoPlay);
            
            const videoLoadingText = document.getElementById('video-loading-text');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error('Error starting video stream:', err);
                videoLoadingText.innerText = 'ไม่สามารถเปิดกล้องได้!';
                showError('ข้อผิดพลาดกล้อง', 'ไม่สามารถเปิดกล้องได้ กรุณาตรวจสอบการอนุญาตใช้งาน');
                stopScanning();
            }
        }

        // เมื่อวิดีโอเริ่มเล่น
        function onVideoPlay() {
            document.getElementById('video-loader').style.display = 'none';
            document.getElementById('video-wrapper').classList.remove('hidden');
            const video = document.getElementById('video');
            const overlay = document.getElementById('overlay');
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            
            if (typeof faceapi !== 'undefined') {
                faceapi.matchDimensions(overlay, displaySize);
            }

            if (recognitionInterval) clearInterval(recognitionInterval);
            recognitionInterval = setInterval(async () => {
                if (!isScanning) return;
                
                // จำลองการจดจำใบหน้า (ในระบบจริงจะใช้ face-api.js)
                if (Math.random() < 0.1) { // 10% chance to "recognize" for demo
                    handleRecognition();
                }
            }, 1000);
        }

        // ฟังก์ชันโหลดโมเดล face-api.js
        async function loadFaceModels() {
            try {
                if (typeof faceapi === 'undefined') {
                    console.log('face-api.js not loaded, using demo mode');
                    return;
                }
                
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                
                // สร้าง face matcher จากรูปภาพนักเรียน
                if (studentData && studentData.imageData) {
                    try {
                        const img = await faceapi.fetchImage(studentData.imageData);
                        const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                        if (detections) {
                            const labeledFaceDescriptors = new faceapi.LabeledFaceDescriptors(studentData.name, [detections.descriptor]);
                            faceMatcher = new faceapi.FaceMatcher([labeledFaceDescriptors], 0.6);
                            console.log('Face matcher ready.');
                        }
                    } catch (e) {
                        console.error('Could not process student image for recognition', e);
                    }
                }
            } catch (error) {
                console.error('Face model loading failed:', error);
            }
        }

        // จัดการเมื่อจดจำใบหน้าได้
        function handleRecognition() {
            // ตรวจสอบตำแหน่งอีกครั้งก่อนบันทึก
            if (!currentLocation || !checkLocationValidity(currentLocation)) {
                showError('อยู่นอกพื้นที่', 'กรุณาเข้ามาภายในรัศมี 50 เมตรจากหน้าเสาธง');
                return;
            }

            // ตรวจสอบเวลาอีกครั้ง
            const timeCheck = isWithinCheckInTime();
            if (!timeCheck.valid) {
                showError('ไม่อยู่ในเวลาที่กำหนด', timeCheck.message);
                return;
            }

            // บันทึกการเช็คชื่อ
            const today = new Date().toDateString();
            const now = new Date();
            const timeString = now.toLocaleTimeString('th-TH', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            let attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '{}');
            if (!attendanceData[today]) {
                attendanceData[today] = {};
            }
            
            // ตรวจสอบว่ามาสายหรือไม่
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const lateTime = 7 * 60 + 30; // 7:30 น.
            const status = currentTime > lateTime ? 'มาสาย' : 'มาเรียน';
            
            attendanceData[today][studentData.id] = {
                name: studentData.name,
                class: studentData.class,
                time: timeString,
                timestamp: now.toISOString(),
                location: currentLocation,
                status: status
            };
            
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // แสดงผลสำเร็จ
            const successOverlay = document.getElementById('scan-success-overlay');
            const successName = document.getElementById('scan-success-name');
            const successTime = document.getElementById('scan-success-time');
            
            successName.textContent = studentData.name;
            successTime.textContent = `${timeString} (${status})`;
            successOverlay.classList.remove('hidden');

            // อัพเดทสถานะบนหน้า
            document.getElementById('attendance-status').textContent = 'เช็คชื่อแล้ว';
            document.getElementById('attendance-status').classList.add('text-green-600');
            document.getElementById('attendance-time').textContent = `เวลา: ${timeString}`;
            
            // หยุดการสแกนชั่วคราว
            isScanning = false;
            
            setTimeout(() => {
                successOverlay.classList.add('hidden');
                stopScanning();
            }, 3000);
        }

        // โหลดหน้า
        window.addEventListener('load', async function() {
            lucide.createIcons();
            loadStudentData();
            await loadFaceModels();
        });
    </script>
</body>
</html>
